@page "/"
@using System.Net.Http.Json
@inject HttpClient Http

<PageTitle>Policy Expert</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="chatbot-container" Style="display: flex;
    flex-direction: column;
    flex: 1;">

    <MudText Typo="Typo.h4" Class="mb-4" Style="flex-shrink: 0;">Policy Expert</MudText>

    <MudPaper Class="pa-4 mb-4" Outlined="true" Style="flex-shrink: 0;">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSelect T="string" Label="Insurance Type" Variant="Variant.Outlined"
                           Value="@selectedInsuranceType" ValueChanged="OnInsuranceTypeChanged">
                    @foreach (var type in insuranceTypes)
                    {
                        <MudSelectItem T="string" Value="@type">@type</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect T="string" Label="Insurer" Variant="Variant.Outlined"
                           Value="@selectedInsurer" ValueChanged="OnInsurerChanged"
                           Disabled="@(string.IsNullOrEmpty(selectedInsuranceType))">
                    @foreach (var insurer in availableInsurers)
                    {
                        <MudSelectItem T="string" Value="@insurer">@insurer</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect T="string" Label="Product" Variant="Variant.Outlined"
                           @bind-Value="selectedProductId"
                           Disabled="@(string.IsNullOrEmpty(selectedInsurer))">
                    @foreach (var product in availableProducts)
                    {
                        <MudSelectItem T="string" Value="@product.Id">@product.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Outlined="true" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0">
        <MudPaper Elevation="0" Class="chat-messages pa-4" 
        Style="flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        margin-bottom: 16px;
        padding: 16px;">
            @foreach (var msg in chatMessages)
            {
                <MudPaper Elevation="1" Class="pa-3 mb-3" Style="@GetMessageStyle(msg.IsUser)">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">
                        <strong>@(msg.IsUser ? "You" : "Policy Expert")</strong>
                    </MudText>
                    <MudText Typo="Typo.body2">@msg.Content</MudText>
                </MudPaper>
            }

            @if (isLoading)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    <em>Policy Expert is typing...</em>
                </MudText>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
            }

        </MudPaper>

        <MudGrid Class="chat-input-section" Style="flex-shrink: 0;">
            <MudItem xs="12">
                <MudTextField @bind-Value="userInput"
                              Label=@GetLabel()
                              Variant="Variant.Outlined"
                              Disabled="@(isLoading || string.IsNullOrEmpty(selectedProductId))"
                              OnKeyDown="HandleKeyPress"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Send"
                              OnAdornmentClick="SendMessage"
                              AdornmentColor="Color.Primary" />
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>